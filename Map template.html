<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>Display a map on a webpage</title>
<meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no">
<link href="https://api.mapbox.com/mapbox-gl-js/v3.17.0/mapbox-gl.css" rel="stylesheet">
<script src="https://api.mapbox.com/mapbox-gl-js/v3.17.0/mapbox-gl.js"></script>
<script
  id="search-js"
  defer
  src="https://api.mapbox.com/search-js/v1.5.0/web.js">
</script>
<style>
body { margin: 0; padding: 0; }
#map { position: absolute; top: 0; bottom: 0; width: 100%; }

/* Search panel wrapper */
.search-panel-wrapper {
  position: absolute;
  top: 1rem;
  right: 1rem;
  z-index: 1;
  font-family: sans-serif;
  pointer-events: none; /* Allow clicks to pass through to map */
}

.search-panel-wrapper h3 {
  margin: 0 0 0.5rem 0;
  color: #333;
  font-size: 1.1rem;
  font-weight: 600;
  text-align: right;
  pointer-events: none;
}

/* Make the search box container interactive */
#search-box-container {
  pointer-events: auto;
}

/* Style the MapboxSearchBox when it's in our container */
.search-panel-wrapper .mapboxgl-ctrl {
  margin: 0;
}
</style>
</head>
<body>
<div id="map"></div>

<!-- Search panel wrapper -->
<div class="search-panel-wrapper">
  <h3>Location Search</h3>
  <div id="search-box-container"></div>
</div>

<script>
    mapboxgl.accessToken = 'pk.eyJ1IjoiYXNhYmtrIiwiYSI6ImNtajFqd2thaTAxaHozY29iMWw0Zm5qOGsifQ.BnE4QsgeWCaiNwzZvWYouQ';
    const map = new mapboxgl.Map({
        container: 'map', // container ID
        style: 'mapbox://styles/mapbox/streets-v12', // map style
        center: [-98.5, 39.8], // center over the continental US
        zoom: 3, // zoomed out to show most of the US
        // restrict panning to the continental United States (tighter bounding box)
        maxBounds: [
            [-125, 24], // southwest coordinates [lng, lat]
            [-66, 50]   // northeast coordinates [lng, lat]
        ]
    });

    // Store marker reference
    let currentMarker = null;
    // Store MapboxSearchBox reference
    let mapboxSearchBox = null;

    // Function to geocode address and zoom to location
    function searchAndZoom() {
        const addressInput = document.querySelector('input[name="address"]');
        const cityInput = document.getElementById('city');
        const stateInput = document.getElementById('state');
        const postcodeInput = document.getElementById('postcode');

        // Build query string from form inputs
        const addressParts = [];
        if (addressInput.value) addressParts.push(addressInput.value);
        if (cityInput.value) addressParts.push(cityInput.value);
        if (stateInput.value) addressParts.push(stateInput.value);
        if (postcodeInput.value) addressParts.push(postcodeInput.value);

        if (addressParts.length === 0) {
            alert('Please enter an address');
            return;
        }

        const query = addressParts.join(', ');

        // Use Mapbox Geocoding API
        const geocodingUrl = `https://api.mapbox.com/geocoding/v5/mapbox.places/${encodeURIComponent(query)}.json?access_token=${mapboxgl.accessToken}&country=US&limit=1`;

        fetch(geocodingUrl)
            .then(response => response.json())
            .then(data => {
                if (data.features && data.features.length > 0) {
                    const feature = data.features[0];
                    const [lng, lat] = feature.center;

                    // Remove existing marker
                    if (currentMarker) {
                        currentMarker.remove();
                    }

                    // Add new marker
                    currentMarker = new mapboxgl.Marker()
                        .setLngLat([lng, lat])
                        .addTo(map);

                    // Zoom and pan to the location with smooth animation
                    map.flyTo({
                        center: [lng, lat],
                        zoom: 15,
                        duration: 2000,
                        essential: true // This ensures the animation completes
                    });

                    // Populate the MapboxSearchBox with the search query
                    if (mapboxSearchBox) {
                        // Wait a moment for the search box to be fully rendered
                        setTimeout(() => {
                            // Try multiple selectors to find the search input
                            const searchBoxInput = document.querySelector('.mapboxgl-ctrl-geocoder input[type="text"]') ||
                                                   document.querySelector('.mapboxgl-ctrl-geocoder .mapboxgl-ctrl-geocoder--input') ||
                                                   document.querySelector('.mapboxgl-ctrl-geocoder input');
                            
                            if (searchBoxInput) {
                                searchBoxInput.value = query;
                                // Trigger input event to show suggestions
                                const inputEvent = new Event('input', { bubbles: true, cancelable: true });
                                searchBoxInput.dispatchEvent(inputEvent);
                                
                                // Also try to trigger the search box's search method if available
                                if (mapboxSearchBox._geocoder) {
                                    mapboxSearchBox._geocoder.query(query);
                                }
                            }
                        }, 100);
                    }
                } else {
                    alert('Address not found. Please try a different address.');
                }
            })
            .catch(error => {
                console.error('Geocoding error:', error);
                alert('Error searching for address. Please try again.');
            });
    }

    // Initialize Mapbox Search autofill when the search-js script has loaded
    const searchScript = document.getElementById('search-js');
    searchScript.onload = function () {
        if (window.mapboxsearch && mapboxsearch.autofill) {
            const autofill = mapboxsearch.autofill({
                accessToken: 'pk.eyJ1IjoiYXNhYmtrIiwiYSI6ImNtajFqd2thaTAxaHozY29iMWw0Zm5qOGsifQ.BnE4QsgeWCaiNwzZvWYouQ'
            });

            // Listen for when an address is selected/retrieved from autofill
            autofill.addEventListener('retrieve', (event) => {
                const feature = event.detail;
                if (feature && feature.geometry && feature.geometry.coordinates) {
                    const [lng, lat] = feature.geometry.coordinates;
                    
                    // Remove existing marker
                    if (currentMarker) {
                        currentMarker.remove();
                    }

                    // Add new marker
                    currentMarker = new mapboxgl.Marker()
                        .setLngLat([lng, lat])
                        .addTo(map);

                    // Zoom and pan to the selected location with smooth animation
                    map.flyTo({
                        center: [lng, lat],
                        zoom: 15,
                        duration: 2000,
                        essential: true // This ensures the animation completes
                    });
                }
            });
        }

        // Add MapboxSearchBox for automatic zoom functionality (waits for window load)
        window.addEventListener('load', () => {
            if (window.MapboxSearchBox) {
                mapboxSearchBox = new MapboxSearchBox();
                mapboxSearchBox.accessToken = 'pk.eyJ1IjoiYXNhYmtrIiwiYSI6ImNtajFqd2thaTAxaHozY29iMWw0Zm5qOGsifQ.BnE4QsgeWCaiNwzZvWYouQ';
                mapboxSearchBox.options = {
                    types: 'address,poi',
                    proximity: [-98.5, 39.8], // Center of US
                    country: 'US' // Restrict to US
                };
                mapboxSearchBox.marker = true;
                mapboxSearchBox.mapboxgl = mapboxgl;
                mapboxSearchBox.componentOptions = { allowReverse: true, flipCoordinates: true };
                
                // Add the search box to our custom container
                const searchContainer = document.getElementById('search-box-container');
                if (searchContainer) {
                    const searchBoxElement = mapboxSearchBox.onAdd(map);
                    searchContainer.appendChild(searchBoxElement);
                } else {
                    // Fallback to standard map control
                    map.addControl(mapboxSearchBox, 'top-right');
                }
            }
        });
    };

</script>

</body>
</html>
